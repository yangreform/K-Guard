<!DOCTYPE html>
<html lang="zh-TW">
<head>
<meta charset="UTF-8">
<meta name="viewport" content="width=device-width, initial-scale=1.0">
<title>呷安全 (K+ Guard) 網頁版</title>
<style>
  body { font-family: sans-serif; margin:0; padding:0; background:#f8f8f8; }
  header { background:#4caf50; color:white; padding:12px 16px; display:flex; justify-content:space-between; align-items:center; }
  main { padding:16px; max-width:800px; margin:auto; }
  h2 { margin-top:24px; }
  input[type=text], input[type=number], input[type=email] { width:100%; padding:8px; margin:4px 0; border:1px solid #ccc; border-radius:4px; }
  button { padding:8px 12px; margin:4px; border:none; border-radius:4px; cursor:pointer; }
  button.primary { background:#4caf50; color:white; }
  button.danger { background:#f44336; color:white; }
  .progress-container { background:#ddd; border-radius:12px; overflow:hidden; margin:4px 0; }
  .progress-bar { height:16px; width:0%; background:#4caf50; }
  .food-item { padding:8px; margin:4px 0; background:white; border-radius:6px; display:flex; justify-content:space-between; align-items:center; cursor:pointer; }
  .badge { padding:4px 8px; border-radius:12px; font-weight:bold; color:white; }
  .low { background:#4caf50; }
  .medium { background:#ff9800; }
  .high { background:#f44336; }
  .cb-low { background:#2196f3; }
  .cb-medium { background:#795548; }
  .cb-high { background:#000; }
  .record { padding:6px; margin:4px 0; background:white; border-radius:6px; display:flex; justify-content:space-between; align-items:center; }
  .flex { display:flex; gap:8px; align-items:center; }
  img.preview { max-width:100%; border-radius:12px; margin-top:8px; }
</style>
</head>
<body>

<header>
  <div>呷安全 (K+ Guard)</div>
  <div>
    <label><input type="checkbox" id="colorBlind"> 色盲模式</label>
  </div>
</header>

<main>
  <!-- 今日進度 -->
  <h2>今日累積鉀攝取</h2>
  <div id="todayTotal">0 / 2000 mg</div>
  <div class="progress-container">
    <div class="progress-bar" id="progressBar"></div>
  </div>

  <!-- 拍照上傳AI辨識 -->
  <h2>拍照上傳AI辨識</h2>
  <div class="flex">
    <!-- 條碼輸入功能保留，但將「確認」按鈕用於圖片上傳 -->
    <input type="text" id="barcodeInput" placeholder="輸入條碼或名稱 (可選)">
    <!-- 這個按鈕現在將觸發圖片上傳和AI辨識 -->
    <button class="primary" onclick="uploadImage()">上傳並辨識</button>
  </div>
  <input type="file" accept="image/*" id="imageInput">
  <img id="preview" class="preview" src="" alt="">
  <!-- 顯示 AI 辨識結果的區域 -->
  <div id="aiResult" style="margin-top: 10px; font-weight: bold;"></div>
  <div id="aiConfidence" style="font-size: 0.9em; color: gray;"></div>


  <!-- 搜尋結果 -->
  <h2>搜尋食物(有2000多種食物，只顯示前5筆)</h2>
  <input type="text" id="searchInput" placeholder="輸入食物名稱或別名">
  <div id="searchResults"></div>

  <!-- 今日紀錄 -->
  <h2>今日紀錄</h2>
  <div id="records"></div>
  <button class="danger" onclick="clearRecords()">清空今日紀錄</button>

  <!-- 每日上限 -->
  <h2>每日鉀攝取上限設定</h2>
  <input type="number" id="dailyLimitInput" value="2000">
  <button class="primary" onclick="saveDailyLimit()">儲存</button>
</main>

<script>
// --- 全域變數 ---
let foods = [];
let records = JSON.parse(localStorage.getItem('kRecords')||'[]');
let dailyLimit = parseFloat(localStorage.getItem('kDailyLimit')||'2000');
let barcodeMap = JSON.parse(localStorage.getItem('kBarcodeMap')||'{}');
let colorBlindMode = false;

// --- DOM ---
const todayTotalEl = document.getElementById('todayTotal');
const progressBarEl = document.getElementById('progressBar');
const searchInput = document.getElementById('searchInput');
const searchResultsEl = document.getElementById('searchResults');
const recordsEl = document.getElementById('records');
const dailyLimitInput = document.getElementById('dailyLimitInput');
const barcodeInput = document.getElementById('barcodeInput');
const imageInput = document.getElementById('imageInput');
const previewImg = document.getElementById('preview');
const colorBlindCheck = document.getElementById('colorBlind');
const aiResultEl = document.getElementById('aiResult'); // 新增：AI 辨識結果 DOM
const aiConfidenceEl = document.getElementById('aiConfidence'); // 新增：AI 信心度 DOM

// --- 從 Apps Script API 載入資料 ---
async function loadFoodData() {
  const url = "https://script.google.com/macros/s/AKfycbyhZIW1GL-y1-0SQFcj8XZ8YPsW2LAIsccc-_KXkKzYWc8QIvZlCBeoVW_B8ZoGCrcwug/exec"; // 換成你的 GAS 網址 (食物資料 API)
  try {
    const res = await fetch(url);
    foods = await res.json();
    renderSearchResults();
  } catch (err) {
    console.error("載入 FoodData 失敗:", err);
    searchResultsEl.innerHTML = "<div style='color:red'>無法載入食物資料</div>";
  }
}

// --- 渲染搜尋結果 ---
function renderSearchResults() {
  const q = searchInput.value.trim();
  const results = q=='' ? foods : foods.filter(f => f.name.includes(q));
  searchResultsEl.innerHTML = '';
  results.slice(0, 5).forEach(f => {
    const div = document.createElement('div');
    div.className = 'food-item';
    div.innerHTML = `
      <span>${f.name} (${f.k ?? '未知'} mg/100g)</span>
      <span class="badge ${levelClass(f.k)}">
        ${f.k==null?'未知':f.k<=100?'低鉀':f.k<=200?'中鉀':'高鉀'}
      </span>`;
    div.onclick = () => addRecord(f);
    searchResultsEl.appendChild(div);
  });
}

// --- 判斷鉀等級 ---
function levelClass(k){
  if(k==null) return 'medium';
  if(colorBlindMode) return k<=100?'cb-low':k<=200?'cb-medium':'cb-high';
  return k<=100?'low':k<=200?'medium':'high';
}

// --- 紀錄操作 ---
function saveRecords(){ localStorage.setItem('kRecords', JSON.stringify(records)); }
function saveDailyLimit(){ dailyLimit = parseFloat(dailyLimitInput.value)||2000; localStorage.setItem('kDailyLimit', dailyLimit); updateTodayTotal(); alert('每日上限已更新'); }
function clearRecords(){ records=[]; saveRecords(); renderRecords(); updateTodayTotal(); }
function addRecord(food, grams=100){
  const k = food.k!=null ? food.k*grams/100 : null;
  const now = new Date().toISOString();
  records.push({id:food.id,name:food.name,grams,k,ts:now});
  saveRecords(); renderRecords(); updateTodayTotal();
  alert(`已加入今日紀錄：${food.name} ${grams}g`);
}
function updateTodayTotal(){
  const total = records.reduce((s,r)=>s+(r.k||0),0);
  todayTotalEl.textContent = `${Math.round(total)} / ${Math.round(dailyLimit)} mg`;
  const ratio = Math.min(total/dailyLimit,1);
  progressBarEl.style.width = (ratio*100)+'%';
  progressBarEl.style.background = colorBlindMode ? '#2196f3' : (total>dailyLimit?'#f44336':'#4caf50');
}
function renderRecords(){
  recordsEl.innerHTML='';
  records.slice().reverse().forEach(r=>{
    const el = document.createElement('div'); el.className='record';
    el.innerHTML = `<div>${r.name} ${r.grams}g → ${Math.round(r.k||0)} mg</div><div>${r.ts.substr(11,5)}</div>`;
    recordsEl.appendChild(el);
  });
}

// --- 圖片預覽 ---
imageInput.addEventListener('change', e=>{
  const file = e.target.files[0];
  if(file){
    previewImg.src = URL.createObjectURL(file);
    previewImg.style.display = 'block'; // 顯示預覽圖
    aiResultEl.textContent = ''; // 清空之前的辨識結果
    aiConfidenceEl.textContent = ''; // 清空之前的信心度
  } else {
    previewImg.src = '';
    previewImg.style.display = 'none'; // 隱藏預覽圖
  }
});

// --- 上傳圖片並進行 AI 辨識 ---
async function uploadImage() {
  const file = imageInput.files[0];
  if (!file) {
    alert('請先選擇一張圖片！');
    return;
  }

  aiResultEl.textContent = '正在上傳並辨識中，請稍候...';
  aiConfidenceEl.textContent = '';

  const reader = new FileReader();
  reader.onloadend = async () => {
    const base64Data = reader.result.split(',')[1]; // 取得 Base64 編碼的圖片資料

    // 替換成你的 Google Apps Script Web 應用程式 URL
    const gasUrl = "YOUR_GOOGLE_APPS_SCRIPT_WEB_APP_URL_FOR_IMAGE_UPLOAD"; // !!! 重要：請替換成你的 GAS 部署後的 URL !!!

    try {
      const response = await fetch(gasUrl, {
        method: 'POST',
        mode: 'cors', // 允許跨域請求
        headers: {
          'Content-Type': 'application/json',
        },
        body: JSON.stringify({ imageData: base64Data }),
      });

      const result = await response.json();

      if (result.status === 'success') {
        if (result.label && result.score) {
          aiResultEl.textContent = `辨識結果：${result.label}`;
          aiConfidenceEl.textContent = `信心度：${(result.score * 100).toFixed(2)}%`;

          // 在搜尋框中自動填入辨識結果，方便使用者手動選擇
          searchInput.value = result.label;
          renderSearchResults();

        } else {
          aiResultEl.textContent = 'AI 未能辨識出食物種類。';
          aiConfidenceEl.textContent = '';
        }
      } else {
        aiResultEl.textContent = `AI 辨識失敗：${result.message || '未知錯誤'}`;
        aiConfidenceEl.textContent = '';
        console.error('Apps Script 錯誤:', result.message);
      }
    } catch (error) {
      aiResultEl.textContent = '上傳或辨識過程中發生錯誤。';
      aiConfidenceEl.textContent = '';
      console.error('上傳圖片錯誤:', error);
    }
  };
  reader.readAsDataURL(file);
}


// --- 事件 & 初始化 ---
searchInput.addEventListener('input', renderSearchResults);
colorBlindCheck.addEventListener('change', ()=>{ colorBlindMode=colorBlindCheck.checked; renderSearchResults(); updateTodayTotal(); });

// 頁面載入初始化
loadFoodData();
renderRecords();
updateTodayTotal();
dailyLimitInput.value=dailyLimit; colorBlindCheck.checked=colorBlindMode;

// 初始隱藏預覽圖
previewImg.style.display = 'none';
</script>
</body>
</html>
